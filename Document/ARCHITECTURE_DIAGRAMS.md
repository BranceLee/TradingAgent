# TradingAgents 架构图

## 1. 系统组件关系图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        USER INTERFACE                               │
├─────────────────────────────────────────────────────────────────────┤
│  Web UI (Streamlit)          CLI (Typer)           API (Python)     │
└────────────┬─────────────────────┬─────────────────────┬────────────┘
             │                     │                     │
             ▼                     ▼                     ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      TRADING AGENTS GRAPH                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐              │
│  │   State     │    │  LLM Config │    │  Memories   │              │
│  │  Manager    │    │   Setup     │    │   System    │              │
│  └─────────────┘    └─────────────┘    └─────────────┘              │
│           │                 │                 │                    │
│           ▼                 ▼                 ▼                    │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    WORKFLOW ENGINE                          │   │
│  │                    (LangGraph)                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                               │                                     │
└───────────────────────────────┼─────────────────────────────────────┘
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         AGENT NETWORK                               │
├─────────────────────────────────────────────────────────────────────┤
│  Analyst Team        Researcher Team      Trader       Risk Team   │
│  ┌─────────────┐    ┌────────────────┐    ┌───────┐    ┌─────────┐  │
│  │Market       │    │Bull Researcher │    │Trader │    │Risky    │  │
│  │Fundamentals │    │Bear Researcher │    └───────┘    │Safe     │  │
│  │News         │    │Research Manager│                 │Neutral  │  │
│  │Social Media │    └────────────────┘                 │Risk     │  │
│  └─────────────┘                                       │Manager  │  │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        TOOL ECOSYSTEM                               │
├─────────────────────────────────────────────────────────────────────┤
│  Data Sources           Tools              Interfaces               │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐              │
│  │Yahoo Finance│    │Market Tools │    │YFinance     │              │
│  │AKShare      │    │Social Tools │    │AKShare      │              │
│  │Finnhub      │    │News Tools   │    │Finnhub      │              │
│  │Reddit       │    │Fund. Tools  │    │Stockstats   │              │
│  │Google News  │    └─────────────┘    └─────────────┘              │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      AI SERVICE PROVIDERS                           │
├─────────────────────────────────────────────────────────────────────┤
│  DeepSeek (推理分析)           Doubao (向量服务)                     │
│  ┌─────────────────┐          ┌─────────────────┐                  │
│  │推理/分析/决策   │          │向量嵌入/检索    │                  │
│  │模型:            │          │模型:            │                  │
│  │- deepseek-chat  │          │- doubao-embedding│                  │
│  │- deepseek-reasoner│        │- large-text-240915│                  │
│  └─────────────────┘          └─────────────────┘                  │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        MEMORY SYSTEM                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐  │
│  │   ChromaDB      │    │  Reflection     │    │  Experience     │  │
│  │  Vector Store   │    │   System        │    │   Learning      │  │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘  │
│           │                       │                       │         │
│           └───────────────────────┼───────────────────────┘         │
│                                   ▼                                 │
│                        ┌─────────────────┐                          │
│                        │  Report Gen.    │                          │
│                        │   System        │                          │
│                        └─────────────────┘                          │
└─────────────────────────────────────────────────────────────────────┘
```

## 2. 数据流向图

```
用户请求
    ↓
TradingAgentsGraph 初始化
    ↓
创建初始状态 (AgentState)
    ↓
分析师工作流开始
    ├─ 市场分析师
    │     ↓
    │   调用工具 (get_YFin_data)
    │     ↓
    │   获取数据 (Yahoo Finance)
    │     ↓
    │   技术指标分析 (Stockstats)
    │     ↓
    │   DeepSeek 分析生成报告
    │     ↓
    │   更新状态 (market_report)
    │
    ├─ 基本面分析师
    │     ↓
    │   调用工具 (get_simfin_xxx)
    │     ↓
    │   获取数据 (SimFin/Finnhub)
    │     ↓
    │   DeepSeek 分析生成报告
    │     ↓
    │   更新状态 (fundamentals_report)
    │
    ├─ 新闻分析师
    │     ↓
    │   调用工具 (get_global_news_openai)
    │     ↓
    │   获取数据 (OpenAI News API)
    │     ↓
    │   DeepSeek 分析生成报告
    │     ↓
    │   更新状态 (news_report)
    │
    └─ 社交媒体分析师
          ↓
        调用工具 (get_reddit_stock_info)
          ↓
        获取数据 (Reddit/PRAW)
          ↓
        DeepSeek 分析生成报告
          ↓
        更新状态 (sentiment_report)

投资辩论阶段
    ↓
多方研究员
    ↓
获取所有分析师报告 → 生成支持论点
    ↓
更新状态 (investment_debate_state.bull_history)
    ↓
空方研究员
    ↓
获取所有分析师报告 → 生成反对论点
    ↓
更新状态 (investment_debate_state.bear_history)
    ↓
研究经理
    ↓
评估辩论内容 → 生成投资计划
    ↓
更新状态 (investment_debate_state.judge_decision, investment_plan)

风险评估阶段
    ↓
交易员
    ↓
获取投资计划 → 生成交易决策
    ↓
更新状态 (trader_investment_plan)
    ↓
风险分析师团队 (激进/保守/中立)
    ↓
评估交易决策 → 生成风险论点
    ↓
更新状态 (risk_debate_state.xxxxx_history)
    ↓
风险经理
    ↓
评估所有风险论点 → 生成最终决策
    ↓
更新状态 (risk_debate_state.judge_decision, final_trade_decision)

记忆学习阶段
    ↓
反思系统 (Reflector)
    ↓
获取当前情况文本 (所有报告合并)
    ↓
调用 Doubao 向量嵌入服务
    ↓
生成向量并存储到 ChromaDB
    ↓
下次决策时检索相似历史经验
    ↓
将历史经验提供给 DeepSeek 决策

报告生成阶段
    ↓
_log_state() 保存完整状态
    ↓
_generate_web_report() 生成报告
    ↓
使用 Jinja2 模板渲染
    ↓
输出 HTML/Markdown 报告
```

## 3. 关键技术组件交互图

```
DeepSeek LLM (分析决策)
    │
    ├── 接收工具调用请求
    │   ↓
    ├── 调用 ToolNode
    │   ↓
    ├── 执行数据获取工具
    │   ↓
    ├── 接收格式化数据
    │   ↓
    ├── 生成分析报告
    │   ↓
    └── 更新 AgentState

Doubao + ChromaDB (向量记忆)
    │
    ├── 接收文本数据
    │   ↓
    ├── Doubao 生成向量嵌入
    │   ↓
    ├── ChromaDB 存储向量
    │   ↓
    ├── 相似性检索
    │   ↓
    └── 返回历史经验

工具生态系统
    │
    ├── 数据接口层 (interface.py)
    │   ↓
    ├── 具体数据源实现
    │   ↓
    ├── Yahoo Finance / AKShare / Finnhub
    │   ↓
    └── 数据处理和格式化

状态管理系统
    │
    ├── AgentState TypedDict
    │   ↓
    ├── 状态字段更新
    │   ↓
    ├── 工作流状态传递
    │   ↓
    └── 决策结果存储
```